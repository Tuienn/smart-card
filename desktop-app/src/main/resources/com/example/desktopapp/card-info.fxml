<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>
<?import javafx.scene.image.*?>
<?import javafx.scene.shape.*?>
<?import javafx.geometry.*?>
<?import org.kordamp.ikonli.javafx.FontIcon?>

<BorderPane xmlns="http://javafx.com/javafx/17" 
            xmlns:fx="http://javafx.com/fxml/1" 
            fx:controller="com.example.desktopapp.controller.CardInfoController"
            styleClass="root">
    
    <top>
        <VBox alignment="CENTER" spacing="10" style="-fx-padding: 15 30 10 30;">
            <!-- Home Button -->
            <HBox alignment="CENTER_LEFT">
                <Button styleClass="btn, btn-secondary" onAction="#onGoHome" style="-fx-min-width: 100; -fx-min-height: 35;">
                    <graphic><FontIcon iconLiteral="fas-home" iconSize="12" styleClass="icon-primary"/></graphic>
                    <text> Trang chủ</text>
                </Button>
            </HBox>
            
            <Label fx:id="titleLabel" text="Xem thông tin thẻ" styleClass="title-small"/>
        </VBox>
    </top>
    
    <center>
        <StackPane fx:id="contentStack" style="-fx-padding: 0 40;">
            
            <!-- State 1: Connecting -->
            <VBox fx:id="connectingState" alignment="CENTER" spacing="15" visible="true">
                <VBox styleClass="card-container" spacing="20" maxWidth="450" alignment="CENTER">
                    <ProgressIndicator styleClass="loading-spinner" style="-fx-min-width: 60; -fx-min-height: 60;"/>
                    <Label fx:id="connectingLabel" text="Đang kết nối thẻ..." styleClass="subtitle" style="-fx-font-size: 16px;"/>
                    <Label text="Đảm bảo thẻ đã được đặt lên đầu đọc" styleClass="text-secondary" style="-fx-font-size: 14px;"/>
                </VBox>
            </VBox>
            
            <!-- State 2: PIN Input -->
            <VBox fx:id="pinInputState" alignment="CENTER" spacing="15" visible="false">
                <VBox styleClass="card-container" spacing="15" maxWidth="450" alignment="CENTER">
                    
                    <HBox alignment="CENTER" spacing="10">
                        <FontIcon iconLiteral="fas-lock" iconSize="24" styleClass="icon-primary"/>
                        <Label text="Xác thực PIN" styleClass="title-small"/>
                    </HBox>
                    <Label text="Nhập mã PIN 6 số để xem thông tin thẻ" styleClass="text-secondary"/>
                    
                    <!-- PIN Display -->
                    <HBox alignment="CENTER" spacing="15" fx:id="pinDotsContainer">
                        <Label fx:id="pinDot1" styleClass="pin-dot, pin-dot-empty"/>
                        <Label fx:id="pinDot2" styleClass="pin-dot, pin-dot-empty"/>
                        <Label fx:id="pinDot3" styleClass="pin-dot, pin-dot-empty"/>
                        <Label fx:id="pinDot4" styleClass="pin-dot, pin-dot-empty"/>
                        <Label fx:id="pinDot5" styleClass="pin-dot, pin-dot-empty"/>
                        <Label fx:id="pinDot6" styleClass="pin-dot, pin-dot-empty"/>
                    </HBox>
                    
                    <!-- Numeric Keypad -->
                    <GridPane hgap="15" vgap="15" alignment="CENTER">
                        <Button text="1" styleClass="keypad-btn" onAction="#onKeypadPress" userData="1"
                                GridPane.columnIndex="0" GridPane.rowIndex="0"/>
                        <Button text="2" styleClass="keypad-btn" onAction="#onKeypadPress" userData="2"
                                GridPane.columnIndex="1" GridPane.rowIndex="0"/>
                        <Button text="3" styleClass="keypad-btn" onAction="#onKeypadPress" userData="3"
                                GridPane.columnIndex="2" GridPane.rowIndex="0"/>
                        
                        <Button text="4" styleClass="keypad-btn" onAction="#onKeypadPress" userData="4"
                                GridPane.columnIndex="0" GridPane.rowIndex="1"/>
                        <Button text="5" styleClass="keypad-btn" onAction="#onKeypadPress" userData="5"
                                GridPane.columnIndex="1" GridPane.rowIndex="1"/>
                        <Button text="6" styleClass="keypad-btn" onAction="#onKeypadPress" userData="6"
                                GridPane.columnIndex="2" GridPane.rowIndex="1"/>
                        
                        <Button text="7" styleClass="keypad-btn" onAction="#onKeypadPress" userData="7"
                                GridPane.columnIndex="0" GridPane.rowIndex="2"/>
                        <Button text="8" styleClass="keypad-btn" onAction="#onKeypadPress" userData="8"
                                GridPane.columnIndex="1" GridPane.rowIndex="2"/>
                        <Button text="9" styleClass="keypad-btn" onAction="#onKeypadPress" userData="9"
                                GridPane.columnIndex="2" GridPane.rowIndex="2"/>
                        
                        <Button styleClass="keypad-btn, keypad-btn-action" onAction="#onPinClearAll"
                                GridPane.columnIndex="0" GridPane.rowIndex="3">
                            <graphic><FontIcon iconLiteral="fas-trash-alt" iconSize="18"/></graphic>
                        </Button>
                        <Button text="0" styleClass="keypad-btn" onAction="#onKeypadPress" userData="0"
                                GridPane.columnIndex="1" GridPane.rowIndex="3"/>
                        <Button styleClass="keypad-btn, keypad-btn-action" onAction="#onPinBackspace"
                                GridPane.columnIndex="2" GridPane.rowIndex="3">
                            <graphic><FontIcon iconLiteral="fas-backspace" iconSize="18"/></graphic>
                        </Button>
                    </GridPane>
                    
                    <Label fx:id="pinInstructionLabel" text="Nhập mã PIN 6 số" styleClass="pin-instruction"/>
                    
                    <!-- Verify Button -->
                    <Button fx:id="verifyBtn" styleClass="btn, btn-primary" onAction="#onVerifyPin" disable="true">
                        <graphic><FontIcon iconLiteral="fas-check" iconSize="14" styleClass="icon-white"/></graphic>
                        <text> XÁC THỰC</text>
                    </Button>
                </VBox>
            </VBox>
            
            <!-- State 3: Card Info Display -->
            <VBox fx:id="cardInfoState" alignment="CENTER" spacing="15" visible="false">
                <VBox styleClass="card-container" spacing="15" maxWidth="650" alignment="CENTER">
                    
                    <!-- Avatar -->
                    <HBox alignment="CENTER">
                        <StackPane styleClass="avatar-placeholder" style="-fx-border-style: solid; -fx-min-width: 80; -fx-min-height: 80; -fx-max-width: 80; -fx-max-height: 80;">
                            <ImageView fx:id="avatarImage" fitWidth="80" fitHeight="80" preserveRatio="true">
                                <clip>
                                    <Circle radius="55" centerX="55" centerY="55"/>
                                </clip>
                            </ImageView>
                            <FontIcon fx:id="avatarPlaceholder" iconLiteral="fas-user" iconSize="48" styleClass="icon-secondary"/>
                        </StackPane>
                    </HBox>
                    
                    <!-- User Info -->
                    <VBox styleClass="glass-panel" spacing="15" alignment="CENTER_LEFT">
                        <HBox spacing="10" alignment="CENTER_LEFT">
                            <FontIcon iconLiteral="fas-user" iconSize="16" styleClass="icon-secondary"/>
                            <Label text="Tên:" styleClass="text-secondary"/>
                            <Label fx:id="nameLabel" text="" styleClass="text-primary" style="-fx-font-weight: bold;"/>
                        </HBox>
                        <HBox spacing="10" alignment="CENTER_LEFT">
                            <FontIcon iconLiteral="fas-birthday-cake" iconSize="16" styleClass="icon-secondary"/>
                            <Label text="Tuổi:" styleClass="text-secondary"/>
                            <Label fx:id="ageLabel" text="" styleClass="text-primary"/>
                        </HBox>
                        <HBox spacing="10" alignment="CENTER_LEFT">
                            <FontIcon iconLiteral="fas-venus-mars" iconSize="16" styleClass="icon-secondary"/>
                            <Label text="Giới tính:" styleClass="text-secondary"/>
                            <Label fx:id="genderLabel" text="" styleClass="text-primary"/>
                        </HBox>
                    </VBox>
                    
                    <!-- Coins Display -->
                    <VBox styleClass="coin-display" alignment="CENTER" spacing="8">
                        <Label text="Số dư" styleClass="text-secondary" style="-fx-font-size: 13px;"/>
                        <HBox alignment="CENTER" spacing="12">
                            <Label fx:id="coinsLabel" text="0" styleClass="coin-amount" style="-fx-font-size: 32px;"/>
                            <HBox alignment="CENTER" spacing="4">
                                <FontIcon iconLiteral="fas-coins" iconSize="20" styleClass="icon-warning"/>
                                <Label text="COINS" style="-fx-font-size: 18px; -fx-text-fill: #fbbf24;"/>
                            </HBox>
                        </HBox>
                    </VBox>
                    
                    <!-- Purchased Games Section -->
                    <VBox styleClass="glass-panel" spacing="10" alignment="CENTER_LEFT">
                        <HBox spacing="8" alignment="CENTER_LEFT">
                            <FontIcon iconLiteral="fas-gamepad" iconSize="16" styleClass="icon-primary"/>
                            <Label text="Trò chơi đã mua" style="-fx-font-size: 14px; -fx-font-weight: bold;" styleClass="text-primary"/>
                        </HBox>
                        
                        <FlowPane fx:id="purchasedGamesContainer" hgap="8" vgap="8" prefWrapLength="400">
                            <!-- Games will be added dynamically in 2 rows -->
                        </FlowPane>

                        <Label fx:id="noGamesLabel" text="Chưa mua trò chơi nào" styleClass="text-secondary"
                               style="-fx-font-style: italic; -fx-padding: 5 0;" visible="false" managed="false"/>
                    </VBox>
                    
                    <!-- Action Buttons -->
                    <HBox fx:id="actionButtonsBox" alignment="CENTER" spacing="20" style="-fx-padding: 10 0 0 0;">
                        <Button styleClass="btn, btn-primary" onAction="#onBuyCoins" style="-fx-min-width: 180;">
                            <graphic><FontIcon iconLiteral="fas-coins" iconSize="14" styleClass="icon-white"/></graphic>
                            <text> NẠP COINS</text>
                        </Button>
                        <Button styleClass="btn, btn-success" onAction="#onBuyCombo" style="-fx-min-width: 180;">
                            <graphic><FontIcon iconLiteral="fas-shopping-cart" iconSize="14" styleClass="icon-white"/></graphic>
                            <text> MUA COMBO</text>
                        </Button>
                    </HBox>
                    
                </VBox>
            </VBox>
            
            <!-- State 4: Error -->
            <VBox fx:id="errorState" alignment="CENTER" spacing="30" visible="false">
                <VBox styleClass="card-container" spacing="30" maxWidth="550" alignment="CENTER">
                    <FontIcon iconLiteral="fas-times-circle" iconSize="64" styleClass="icon-danger"/>
                    <Label fx:id="errorLabel" text="Có lỗi xảy ra" styleClass="subtitle" style="-fx-text-fill: #ef4444; -fx-text-alignment: center;"/>
                    
                    <!-- Action buttons container -->
                    <VBox fx:id="errorButtonsContainer" alignment="CENTER" spacing="15" style="-fx-padding: 10 0 0 0;">
                        <HBox alignment="CENTER" spacing="20">
                            <Button styleClass="btn, btn-secondary" onAction="#onRetry" style="-fx-min-width: 150;">
                                <graphic><FontIcon iconLiteral="fas-redo" iconSize="14" styleClass="icon-primary"/></graphic>
                                <text> THỬ LẠI</text>
                            </Button>
                            <Button fx:id="unlockCardBtn" styleClass="btn, btn-warning" onAction="#onUnlockCard" visible="false" style="-fx-min-width: 150;">
                                <graphic><FontIcon iconLiteral="fas-unlock" iconSize="14" styleClass="icon-white"/></graphic>
                                <text> MỞ KHÓA THẺ</text>
                            </Button>
                        </HBox>
                        
                        <!-- Warning message for unlock -->
                        <VBox fx:id="unlockWarningBox" alignment="CENTER" spacing="8" visible="false" styleClass="glass-panel" style="-fx-background-color: rgba(239, 68, 68, 0.1); -fx-border-color: #ef4444; -fx-border-width: 1; -fx-border-radius: 8; -fx-background-radius: 8; -fx-padding: 15;">
                            <HBox alignment="CENTER" spacing="8">
                                <FontIcon iconLiteral="fas-exclamation-triangle" iconSize="18" style="-fx-fill: #f59e0b;"/>
                                <Label text="Cảnh báo quan trọng" style="-fx-font-weight: bold; -fx-text-fill: #f59e0b; -fx-font-size: 14px;"/>
                            </HBox>
                            <Label text="Cố gắng tự ý mở khóa có thể làm mất thẻ vĩnh viễn." styleClass="text-secondary" style="-fx-text-alignment: center; -fx-font-size: 13px;"/>
                            <Label text="Chỉ người có thẩm quyền mới được thực hiện thao tác này." styleClass="text-secondary" style="-fx-text-alignment: center; -fx-font-size: 13px; -fx-font-weight: bold;"/>
                        </VBox>
                    </VBox>
                </VBox>
            </VBox>
            
        </StackPane>
    </center>
    
</BorderPane>
